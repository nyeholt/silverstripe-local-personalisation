!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){var i=n(2),o=n(3);e.exports=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var a=(e=e||{}).random||(e.rng||i)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t)for(var s=0;s<16;++s)t[r+s]=a[s];return t||o(a)}},function(e,t,n){n(6),e.exports=n(5)},function(e,t){var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(n){var i=new Uint8Array(16);e.exports=function(){return n(i),i}}else{var o=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),o[t]=e>>>((3&t)<<3)&255;return o}}},function(e,t){for(var n=[],i=0;i<256;++i)n[i]=(i+256).toString(16).substr(1);e.exports=function(e,t){var i=t||0,o=n;return[o[e[i++]],o[e[i++]],o[e[i++]],o[e[i++]],"-",o[e[i++]],o[e[i++]],"-",o[e[i++]],o[e[i++]],"-",o[e[i++]],o[e[i++]],"-",o[e[i++]],o[e[i++]],o[e[i++]],o[e[i++]],o[e[i++]],o[e[i++]]].join("")}},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var i,o=n(0),r=n.n(o);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"data",void 0),s(this,"ruleset",void 0),s(this,"points",void 0),s(this,"sortedPoints",void 0),s(this,"version",void 0),s(this,"clickRules",void 0),s(this,"timeRules",void 0),s(this,"myPosition",void 0),this.ruleset=t,this.points=n,this.version=i||1,this.clickRules={}}var t,n,i;return t=e,(n=[{key:"evaluateRequest",value:function(){var e=this;this.checkRules(),this.checkContent(),this.points.length>0&&navigator.geolocation&&navigator.geolocation.getCurrentPosition((function(t){if(t.coords){for(var n=t.coords.latitude,i=t.coords.longitude,o=[],r=0;r<e.points.length;r++){var a=e.points[r];a.distance=e.distance(n,i,a.lat,a.lon),o.push(a)}e.sortedPoints=o.sort((function(e,t){return e.distance<t.distance?-1:e.distance==t.distance?0:1})),e.checkLocation()}})),setTimeout((function(){console.log("Profile.js: checking 3s rules"),e.checkRules(3),e.checkContent()}),3e3),setTimeout((function(){console.log("Profile.js: checking 10s rules"),e.checkRules(10),e.checkContent()}),1e4),setTimeout((function(){console.log("Profile.js: checking 30s rules"),e.checkRules(30),e.checkContent()}),3e4),setTimeout((function(){console.log("Profile.js: checking 120s rules"),e.checkRules(120),e.checkContent()}),12e4)}},{key:"checkRules",value:function(e){for(var t=this,n=!1,i=0;i<this.ruleset.length;i++){var o=this.ruleset[i],r=parseInt(o.time);if(!(e&&r!=e||!e&&r)){var a=!1;if(o.windows&&o.windows.length&&0==o.windows.filter((function(e){return t.isTimeInWindow(e)})).length){console.log("Profile.js: Ignoring rule out of time band");continue}if("click"===o.event&&o.target?this.clickRules[o.target]=i:o.selector?a=this.isCssMatch(o):o.regex&&(a=this.isMatch(o)),a){n=!0;var s=this.extractData(o);s&&s.length>0&&(console.log("Profile.js: apply from page match",s),this.applyRule(o,s))}}}n&&this.save(),!e&&Object.keys(this.clickRules).length>0&&this.bindClickEvents()}},{key:"checkLocation",value:function(){for(var e=!1,t=0;t<this.ruleset.length;t++){var n=this.ruleset[t],i=!1;if("location"==n.appliesTo&&(i=this.nearestPoint(n)),i){e=!0;var o=this.extractData(n);o&&o.length>0&&(console.log("Profile.js: apply from location match",o),this.applyRule(n,o))}}e&&this.save()}},{key:"isTimeInWindow",value:function(e,t){var n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime()/1e3;t||(t=Math.ceil(n.getTime()/1e3));var o=parseInt(e[0])+i,r=parseInt(e[1])+i;return t>o&&t<r}},{key:"checkContent",value:function(){var e=document.getElementsByClassName("lp-item"),t=this.data.tags;if(e)for(var n=0;n<e.length;n++){var i=e[n],o=i.getAttribute("data-lp-applicable");if(o&&o.length&&o.indexOf("-")>0&&!this.isTimeInWindow(o.split("-")))console.log("missed time band");else{var r=[i.getAttribute("data-lp-show-tags"),i.getAttribute("data-lp-show-times")||1,i.getAttribute("data-lp-show-timeblock")||0,t],a=[i.getAttribute("data-lp-hide-tags"),i.getAttribute("data-lp-hide-times")||1,i.getAttribute("data-lp-hide-timeblock")||0,t],s=this.matchesTags.apply(this,r),l=this.matchesTags.apply(this,a);if(s||l){var c="show";i.hasAttribute("data-lp-prefer")&&(c=i.getAttribute("data-lp-prefer"));var u={matchType:c,showMatches:s,hideMatches:l};console.log("Profile.js: Trigger local_profile_match_tag",u),this.triggerEvent("local_profile_match_tag",u),"show"===c&&s?(i.classList.remove("lp-hide"),i.classList.add("lp-show")):"hide"===c&&l?(i.classList.remove("lp-show"),i.classList.add("lp-hide")):s?(i.classList.remove("lp-hide"),i.classList.add("lp-show")):l&&(i.classList.remove("lp-show"),i.classList.add("lp-hide"))}}}}},{key:"matchesTags",value:function(e,t,n,i,o){if(e&&e.length>0){for(var r=[],a="+"===e[0],s=e.replace("+","").replace(" ","").split(","),l=0;l<s.length;l++)if(!(s[l].length<=0)){var c="!"==s[l][0],u=s[l].replace("!","");if(!(!i[u]&&!c||i[u]&&c)){console.log("Profile.Js: "+s[l]+" matched profile");var h=i[u],f=[];if(n>0&&h?function(){var e=1e3*n;f=h.acc.filter((function(t){return t.t>e}))}():f=h?h.acc:[],t>1&&t>(f||[]).length)break;r.push(s[l])}}return(a?r.length==s.length:r.length>0)?r:null}}},{key:"bindClickEvents",value:function(){var e=this;document.addEventListener("click",(function(t){var n=!1;for(var i in e.clickRules){var o=t.target;if(o.matches(i)){var r=e.clickRules[i],a=e.ruleset[r],s=!0;if(a.selector?s=e.isCssMatch(a):a.regex&&(s=e.isMatch(a)),s){var l=e.extractData(a);l?(l.push(o.getAttribute("href")),l.push(o.innerHTML)):l=[o.getAttribute("href"),o.innerHTML],l&&l.length>0&&(console.log("Profile.js: apply from event match",l),e.applyRule(a,l),n=!0)}}}n&&e.save()}))}},{key:"extractData",value:function(e){var t=e.extractor,n=[];if(t.selector&&t.attribute)document.querySelectorAll(t.selector).forEach((function(e){"#content"===t.attribute?n.push(e.innerHTML):n.push(e.getAttribute(t.attribute))}));else if(t.regex){var i=this.getContentFor(t);n=new RegExp(e.regex).exec(i)}else if("location"==t.appliesTo){var o=this.nearestPoint(t);n.push(o.title)}else"none"==t.appliesTo&&n.push(document.title);return n}},{key:"getContentFor",value:function(e){var t=null;return"url"==e.appliesTo?t=location.href:"referrer"==e.appliesTo?t=document.referrer:"content"==e.appliesTo||"click"==e.appliesTo?t=document.querySelector("body").innerHTML:"useragent"==e.appliesTo&&(t=navigator.userAgent),t}},{key:"nearestPoint",value:function(e){if(this.points&&this.points.length>0){if(e.matchnearest)return this.points[0];if(!e.maxdistance)return;for(var t=0;t<this.points.length;t++)if(this.points[t].distance<e.maxdistance)return this.points[t]}else console.warn("Profile.js: No position information available to check location rules")}},{key:"isMatch",value:function(e){var t=this.getContentFor(e),n=new RegExp(e.regex).exec(t);return n&&n.length>0}},{key:"isCssMatch",value:function(e){if(e.selector)return document.querySelectorAll(e.selector).length>0}},{key:"applyRule",value:function(e,t){var n=this;if(e.apply&&e.apply.length>0){this.triggerEvent("local_profile_apply_rule",e);for(var i=function(i){var o=e.apply[i];o.indexOf("$")>=0&&t&&t.length>0&&t.forEach((function(e,t){o=(o=o.replace("$"+t,e))?o.trim():""})),n.addTag(o)},o=0;o<e.apply.length;o++)i(o)}}},{key:"addTag",value:function(e){var t=e.replace(/[^A-Za-z0-9_-]/g,"-").toLowerCase();this.data.tags||(this.data.tags={});var n=this.data.tags[t];for(n||(n={acc:[]});n.acc.length>=10;)n.acc.pop();var i={t:(new Date).getTime(),u:location.href,r:e};this.triggerEvent("local_profile_add_tag",i),n.acc.unshift(i),this.data.tags[t]=n}},{key:"findOldestTag",value:function(){var e=null,t=null;for(var n in(new Date).getTime(),this.data.tags){var i=this.data.tags[n];if(!i.acc||0===i.acc.length)return n;var o=i.acc[i.acc.length-1];(!t||t>o.t)&&(t=o.t,e=n)}return e}},{key:"loadFromStore",value:function(){var e=localStorage.getItem("lp_user_state");if(e&&e.length>0){var t=JSON.parse(e);if(t&&t.uid&&t.version&&t.version==this.versionString())return this.data=t,!0}return!1}},{key:"writeToStore",value:function(){if(this.data||(this.data={version:this.versionString(),uid:r()(),tags:{}}),Object.keys(this.data.tags).length>50){var e=this.findOldestTag();e&&delete this.data.tags[e]}localStorage.setItem("lp_user_state",JSON.stringify(this.data))}},{key:"versionString",value:function(){return"2."+this.version}},{key:"save",value:function(){this.writeToStore()}},{key:"triggerEvent",value:function(e,t,n){n||(n=document);var i=new CustomEvent(e,t?{detail:t}:null);n.dispatchEvent(i)}},{key:"distance",value:function(e,t,n,i,o){if(o||(o="K"),e==n&&t==i)return 0;var r=Math.PI*e/180,a=Math.PI*n/180,s=t-i,l=Math.PI*s/180,c=Math.sin(r)*Math.sin(a)+Math.cos(r)*Math.cos(a)*Math.cos(l);return c>1&&(c=1),c=60*(c=180*(c=Math.acos(c))/Math.PI)*1.1515,"K"==o&&(c*=1.609344),"N"==o&&(c*=.8684),c}}])&&a(t.prototype,n),i&&a(t,i),e}();!function(){if(Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),"function"==typeof window.CustomEvent)return!1;function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}e.prototype=window.Event.prototype,window.CustomEvent=e}();n(4);if(window.PERSONSALISATION_RULESET){window.addEventListener("load",(function(){var e,t,n,o=(e=window.PERSONSALISATION_RULESET.rules,t=window.PERSONSALISATION_RULESET.points,n=window.PERSONSALISATION_RULESET.version,(i=new l(e,t,n)).loadFromStore()||i.writeToStore(),i);o.evaluateRequest(),window.DEBUG_SHOW_PROFILE=function(){console.log(o.data)}}))}else console.warn("Profile.js: PERSONSALISATION_RULESET not found")}]);